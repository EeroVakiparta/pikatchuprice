<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/manifest.json">
    <title>Pikatchu Prices (aka. PP)</title>

</head>

<body onload="fetchData()">
    <img src="https://www.freeiconspng.com/uploads/pikachu-transparent-29.gif" width="350" alt="Pikachu" />
    </a>
    <h1>Electricity Prices for Next 48 Hours</h1>
    <button id="subscribeButton">Subscribe to Notifications</button>

    <table border="1">
        <thead>
            <tr>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Price (€)</th>
            </tr>
        </thead>
        <tbody id="priceTableBody">
            <!-- Data will be inserted here -->
        </tbody>
    </table>
    <script>
        async function fetchData() {
            const response = await fetch('https://r8carkxrn0.execute-api.eu-north-1.amazonaws.com/prod/');
            const data = await response.json();
            const prices = data.prices;

            // Create table rows from the data
            let tableRows = '';
            prices.forEach((priceObj) => {
                tableRows += `<tr>
          <td>${new Date(priceObj.startDate).toLocaleString()}</td>
          <td>${new Date(priceObj.endDate).toLocaleString()}</td>
          <td>${priceObj.price.toFixed(2)} €</td>
        </tr>`;
            });

            // Insert rows into the table
            document.getElementById('priceTableBody').innerHTML = tableRows;
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then((registration) => {
                    console.log('Service Worker registered:', registration);
                })
                .catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
        }
        // Add this JavaScript code to handle button click
        document.getElementById('subscribeButton').addEventListener('click', function () {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    return Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            return registration.pushManager.getSubscription();
                        } else {
                            throw new Error('Permission not granted for Notification');
                        }
                    }).then(subscription => {
                        if (subscription) {
                            return subscription;
                        }

                        const applicationServerKey = urlB64ToUint8Array('BDpwQcSAieOuATojYHthzD4cExNIYS9571KxDdXkQrlR3GZV2cq3nBnHYSNWPuzZOCln9D7SK_eDbd9NvFdv1lE');
                        return registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: applicationServerKey
                        });
                    });
                }).then(subscription => {
                    console.log(JSON.stringify(subscription));
                }).catch(error => {
                    console.log('Failed to subscribe the user: ', error);
                });

            } else {
                console.log('Service workers are not supported.');
            }
        });

        // Helper function to convert base64 string to Uint8Array
        function urlB64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

    </script>
</body>

</html>